name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  check-migrations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --no-root

      - name: Check for multiple heads
        run: |
          echo "Checking for multiple migration heads..."

          # For PRs, check if merging with main would create conflicts
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Simulating merge with base branch to detect conflicts..."
            
            # Get current PR migrations
            echo "PR branch migrations:"
            PR_MIGRATIONS=$(ls -1 alembic/versions/*.py 2>/dev/null | grep -v __pycache__ || true)
            echo "$PR_MIGRATIONS"
            echo ""
            
            # Fetch and get main branch migrations
            git fetch origin ${{ github.base_ref }}
            echo "Fetching main branch migrations..."
            git checkout origin/${{ github.base_ref }} -- alembic/versions/
            
            echo "Main branch migrations:"
            MAIN_MIGRATIONS=$(ls -1 alembic/versions/*.py 2>/dev/null | grep -v __pycache__ || true)
            echo "$MAIN_MIGRATIONS"
            echo ""
            
            # Now we have BOTH sets of migrations - check for multiple heads
            echo "Checking combined migrations (simulated merge)..."
            HEADS=$(alembic heads 2>&1)
            HEAD_COUNT=$(echo "$HEADS" | grep -E "^[a-f0-9]+ \(head\)" | wc -l)
            
            echo "Combined migration heads:"
            echo "$HEADS"
            echo ""
            echo "Number of heads: $HEAD_COUNT"
            
            if [ "$HEAD_COUNT" -gt 1 ]; then
              echo "❌ ERROR: Multiple migration heads detected after merge!"
              echo "This indicates a migration conflict between your PR and ${{ github.base_ref }}."
              echo ""
              echo "To fix this:"
              echo "1. Pull the latest changes from ${{ github.base_ref }}"
              echo "2. Delete your migration file"
              echo "3. Merge/rebase with ${{ github.base_ref }}"
              echo "4. Recreate your migration: alembic revision --autogenerate -m 'your message'"
              echo ""
              echo "Alternatively, you can merge the heads:"
              echo "  alembic merge heads -m 'merge migration heads'"
              exit 1
            fi
            
            # Restore PR state
            git checkout HEAD -- alembic/versions/
          else
            # For push to main, just check current state
            HEADS=$(alembic heads 2>&1)
            HEAD_COUNT=$(echo "$HEADS" | grep -E "^[a-f0-9]+ \(head\)" | wc -l)

            echo "Migration heads found:"
            echo "$HEADS"
            echo ""
            echo "Number of heads: $HEAD_COUNT"

            if [ "$HEAD_COUNT" -gt 1 ]; then
              echo "❌ ERROR: Multiple migration heads detected!"
              echo "This indicates a migration conflict."
              exit 1
            fi
          fi
          
          echo "✅ SUCCESS: No migration conflicts detected."

      - name: Check for duplicate revision IDs
        run: |
          echo "Checking for duplicate revision IDs..."

          DUPLICATES=$(grep -r "^revision.*=.*['\"]" alembic/versions/*.py | \
                       sed "s/.*['\"]\\([a-f0-9]*\\)['\"].*/\\1/" | \
                       sort | uniq -d)

          if [ -n "$DUPLICATES" ]; then
            echo "❌ ERROR: Duplicate revision IDs found:"
            echo "$DUPLICATES"
            exit 1
          fi

          echo "✅ No duplicate revision IDs found."

      - name: Compare with base branch (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking migrations against base branch..."

          BASE_BRANCH="${{ github.base_ref }}"
          echo "Base branch: $BASE_BRANCH"

          # Get the merge base
          git fetch origin "$BASE_BRANCH"
          MERGE_BASE=$(git merge-base HEAD "origin/$BASE_BRANCH")

          # Get new migration files in this PR
          NEW_MIGRATIONS=$(git diff --name-only "$MERGE_BASE" HEAD -- alembic/versions/ | grep "\.py$" | grep -v __pycache__ || true)

          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "New migrations in this PR:"
            echo "$NEW_MIGRATIONS"
            echo ""
            
            # For each new migration, check its down_revision
            for migration in $NEW_MIGRATIONS; do
              echo "Checking $migration..."
              DOWN_REV=$(grep "down_revision.*=.*['\"]" "$migration" | sed "s/.*['\"]\\([a-f0-9]*\\)['\"].*/\\1/" | head -1)
              
              if [ "$DOWN_REV" != "None" ] && [ -n "$DOWN_REV" ]; then
                echo "  Down revision: $DOWN_REV"
                
                # Check if the parent revision exists in base branch
                git checkout "origin/$BASE_BRANCH" -- alembic/versions/ 2>/dev/null || true
                
                PARENT_EXISTS=$(grep -l "revision.*=.*['\"]$DOWN_REV['\"]" alembic/versions/*.py 2>/dev/null || echo "")
                
                # Restore current branch migrations
                git checkout HEAD -- alembic/versions/
                
                if [ -z "$PARENT_EXISTS" ]; then
                  echo "  ⚠️  Warning: Parent revision $DOWN_REV not found in base branch"
                  echo "  This might indicate you need to rebase on the latest changes"
                else
                  echo "  ✅ Parent revision exists in base branch"
                fi
              fi
            done
          else
            echo "No new migrations found in this PR."
          fi

  trigger-prs:
    runs-on: ubuntu-latest
    needs: check-migrations
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger CI on open PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching open PRs..."
          gh pr list --base main --state open --json number,headRefName --jq '.[] | "\(.number) \(.headRefName)"' | while read pr_num branch; do
            echo "Checking PR #$pr_num ($branch)"
            # Find the latest workflow run for this PR
            run_id=$(gh run list --workflow ci.yaml --branch "$branch" --event pull_request --limit 1 --json databaseId --jq '.[0].databaseId')
            
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              echo "Rerunning workflow run $run_id for PR #$pr_num"
              gh run rerun "$run_id" || echo "Failed to rerun $run_id"
            else
              echo "No workflow run found for PR #$pr_num"
            fi
          done
