name: Notify PRs After Main Update

# When main/develop is updated, notify all open PRs to update their branches
# This ensures developers rebase and CI re-runs to catch migration conflicts

on:
  push:
    branches:
      - main
      - develop

# Grant permissions to push to PR branches
permissions:
  contents: write
  pull-requests: read

jobs:
  trigger-pr-ci:
    name: Trigger CI on Open PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Trigger CI on all open PRs
        run: |
          # Get all open PRs
          PRS=$(gh pr list --base main --state open --json number,headRefName --jq '.[] | "\(.number):\(.headRefName)"')
          
          if [ -z "$PRS" ]; then
            echo "No open PRs found"
            exit 0
          fi
          
          echo "$PRS" | while IFS=: read -r PR_NUMBER BRANCH; do
            echo "Triggering CI for PR #$PR_NUMBER (branch: $BRANCH)"
            
            # Fetch and checkout the PR branch
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            
            # Create an empty commit to trigger CI
            git commit --allow-empty -m "chore: trigger CI after base branch update [skip ci]"
            
            # Push to trigger the workflow
            git push origin "$BRANCH"
            
            echo "âœ“ Triggered CI for PR #$PR_NUMBER"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
